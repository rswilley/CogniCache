@using CogniCache.Application
@using CogniCache.Application.Queries
@using CogniCache.Domain.Repositories.TagRepository
@using CogniCache.Domain.Services
@using CogniCache.Infrastructure.Services
@using CogniCache.Shared.Components
@using CogniCache.Shared.Services

@inject IRequest<GetAllTagsQuery, GetAllTagsQueryResponse> GetAllTagsQueryHandler
@inject IConfigurationService ConfigService
@inject INoteService NoteService;
@inject IPubSubService PubSubService;

<Bar Breakpoint="Breakpoint.Desktop" NavigationBreakpoint="Breakpoint.Tablet" Background="Background.Dark" ThemeContrast="ThemeContrast.Dark"
Mode="BarMode.VerticalInline" CollapseMode="BarCollapseMode.Small" MenuToggleBehavior=BarMenuToggleBehavior.AllowSingleMenu>
    <BarToggler />
    <BarBrand>
        <BarItem>
            <BarLink To="">
                <BarIcon IconName="_customIcon" />
                CogniCache
            </BarLink>
        </BarItem>
    </BarBrand>
    <BarMenu>
        <BarStart>
            <BarItem>
                <BarLink To="">
                    <BarIcon IconName="IconName.Dashboard" />
                    Dashboard
                </BarLink>
            </BarItem>
            <BarItem>
                <BarLink To="/memos">
                    <BarIcon IconName="IconName.StickyNote" />
                    Memos
                </BarLink>
            </BarItem>
            <BarItem>
                <BarLink To="/notes">
                    <BarIcon IconName="IconName.StickyNote" />
                    Notes
                </BarLink>
            </BarItem>
            <BarItem>
                <BarDropdown>
                    <BarDropdownToggle>
                        <BarIcon IconName="IconName.Tag" />
                        Tags
                    </BarDropdownToggle>
                    <BarDropdownMenu>
                        @foreach (var tag in _tags) {
                            <ChildDropdownItem Tag="tag" />
                        }
                    </BarDropdownMenu>
                </BarDropdown>
            </BarItem>
        </BarStart>
        <BarEnd>
            <BarItem>
                <BarDropdown>
                    <BarDropdownToggle>
                        <BarIcon IconName="IconName.Settings" />
                        Settings
                    </BarDropdownToggle>
                    <BarDropdownMenu>
                        <BarDropdownItem>
                            <Button @onclick="ReindexNotes" Color="Color.Primary" Type="ButtonType.Button">Reindex Notes</Button>
                        </BarDropdownItem>
                    </BarDropdownMenu>
                </BarDropdown>
            </BarItem>
        </BarEnd>
    </BarMenu>
</Bar>

@code {
    private IEnumerable<Tag> _tags = [];

    readonly RenderFragment _customIcon = @<img src="_content/CogniCache.Shared/img/cognicache-logo.png" style="width:40px; height: 40px"/>;

    protected override void OnInitialized()
    {
        ConfigService.LoadConfiguration();
        _tags = GetAllTagsQueryHandler.Handle(new GetAllTagsQuery()).Tags;
        PubSubService.Notify += UpdateMessage;
    }

    public void Dispose()
    {
        PubSubService.Notify -= UpdateMessage;
    }

    private void UpdateMessage(IMessage message)
    {
        if (message is not UpdateTagsMessage)
            return;

        _tags = GetAllTagsQueryHandler.Handle(new GetAllTagsQuery()).Tags;
        InvokeAsync(StateHasChanged);
    }

    private void ReindexNotes()
    {
        NoteService.ReindexNotes();
    }
}
